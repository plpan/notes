### 总体布局
总体而言，一块磁盘可以被划分成多个分区，而每个分区都能被格式化工具（如mkfs）格式化为具体的文件系统，格式化工具会在该分区中写入一些管理存储布局的信息，然后该分区才能开始存储文件。ext2文件系统的布局如下图所示：

```
          +---------------|---------------|--------------|---------------+
          |               |               |              |               |
          |  boot block   | block group 0 |    ......    | block group N |
          |               |               |              |               |
          +---------------|---------------|--------------|---------------+
                          |               |                               
                          |               |                               
                          |               |                               
--------------------------+               +--------------------------|    
|                                                                    |    
|                                                                    |    
v----------|------------|----------|-----------|----------|----------v    
|  super   | group      |  block   |   inode   |  inode   |   data   |    
|          | descriptor |          |           |          |          |    
|  block   | table      |  bitmap  |   bitmap  |  table   |  blocks  |    
+----------|------------|----------|-----------|----------|----------+
```
文件系统中最小单位是块（block），块大小在格式化时就需要被指定。常见大小有1K、4K等。而上图中的启动块（boot block）则是PC标准规定的，固定位1K，主要是用来存储磁盘分区信息和启动信息，任何文件系统都不允许使用启动块。启动块之后才是ext2文件系统的本体，ext2文件系统将整个分区划分成若干个同样大小的块组（block group），每个块组都是由以下部分组成：
- 超级快（super block）：描述整个分区的信息，如块大小、文件系统版本号、mount时间等。
- 块组描述符表（GDT）：由很多块组描述符组成，每个块组描述符存储一个块组的描述信息，如inode表的开始位置、数据块的开始位置、空闲的inode和数据块数目等。注意块组描述符表在每个块组开头都有一个拷贝，通常内核仅使用第0个块组中的拷贝。当执行e2fsck检查文件系统一致性时，第0个块组中的超级块和块组描述符表都会被拷贝至其他块组，这样当第0个块组开头意外损坏时，可以使用其他拷贝来修复。
- 块位图（block bitmap）：因为底层文件系统都是按块来存储文件，块位图就是用来表示整个块组中哪些块已经被使用，哪些块还处于空闲状态。注意块位图本身只占用一个块，其中的每个bit都描述本块组中的一个块，1就表示已被使用，0则表示该块空闲。
	- 由于块位图仅占用一个块，因此当块大小确定后，块组的数量也就能够被计算出来：磁盘大小/(块大小*8)。
	- 当使用df命令统计磁盘已用空间非常快，因为它就是统计块位图的使用情况；而使用du则比较慢，因为它需要遍历整个目录的所有文件。
- inode位图（inode bitmap）：与块位图类似，但是inode位图是用来表示inode是否可用。
- inode表（inode table）：文件除了本身的数据需要存储之外，还需要存储文件描述相关的信息，如文件类型、权限、文件大小、时间相关等信息，通过ls -l就能够查看文件的这类信息。文件的描述信息并非存储在数据块中，而是存储在inode中，也即每个文件都会有一个inode，而一个块组中所有的inode就组成了inode表。
	- inode表占用块的数目需要在格式化时指定。e2fsck默认策略是每8KB就分配一个inode。也即，当文件大小为8KB左右时，能够充分利用整个分区。太大或太小都无法充分利用。
- 数据块（data blocks）：数据块中存储的内容主要有一下几类：
	- 常规文件：文件数据存储在数据块中
	- 目录：该目录下所有的文件名和目录名都存储在数据块中，目录其实也是一种特殊的文件。需要注意的是，除了文件名，其他信息都保存在该文件的inode中。
	- 符号链接：如果目标路径名较短，则直接存储在inode中，以便快速查找，否则就分配一个数据块来存储路径名。
	- 设备文件、FIFO及socket等特殊文件：没有数据块，设备文件的主设备号和次设备号都存储在inode中。

### 硬链接和软链接
- 硬链接：ln source_file target_file，为source_file创建一个名为target_file的硬链接
	- 新的文件名被存储到对应目录的数据块中，两个文件复用一个inode，并且inode中引用技术加1
	- 删除硬链接时，只需要抹除对应目录数据块中的记录即可，如果该硬链接是最后一个引用，则需要彻底删除该文件（包括inode和数据块）
	- 不能为目录创建硬链接
- 软链接：ln -s source_file target_file，为source_file创建一个名为target_file的软链接
	- 新的文件名被存储到对应目录的数据块中，并且会创建一个新的inode来描述target_file，如果source_file长度较短，就直接将其存储在inode中，否则就新建一个数据块来存储source_file路径
	- 删除软链接时，只会抹除对应目录数据块中的记录
	- 可以创建目录的软链接

### 成员结构
下面以块大小为1KB、块数目为1024为例描述主要模块的结构：

#### 块组描述符表
```
Group 0: (Blocks 1-1023)
Primary superblock at 1, Group descriptors at 2-2 Reserved GDT blocks at 3-5
Block bitmap at 6 (+5), Inode bitmap at 7 (+6) Inode table at 8-23 (+7)
986 free blocks, 117 free inodes, 2 directories Free blocks: 38-1023
Free inodes: 12-128
```
- 第0块是启动块
- 第1块是超级快
- 第2~5块是块组描述符表
- 第6块是块位图
- 第7块是inode位图
- 第8~23块是inode表
- 第24~1023是数据块

```
        16              12              8              4        2      0
        +---------------|---------------|--------------|--------|------+
        |               |               |              | free   |free  |
 000800 |block bitmap:6 |inode bitmap:7 |inode table:8 | blocks |inodes|
        |               |               |              | 986    |117   |
        +---------------|----------------------------------------------+
        |               |                                              |
 000810 | 2 directories |               padding                        |
        |               |                                              |
        +---------------|----------------------------------------------+
```
由于块组描述符表从第2块开始，因此其起止地址为0x000800。

#### inode (根目录inode为例)
```
        16                12                8               4         2       0
        +--------|--------|----------------|-----------------|----------------+
        |st_mode |user    |                |                 |                |
 002080 |040755  |1000    |  size: 1024    |      atime      |     ctime      |
        |        |        |                |                 |                |
        +-----------------|----------------|---------|-------|----------------+
        |                 |                |  group  | links |                |
 002090 |      mtime      |     dtime      |  1000   | 3     |  blockcount:2  |
        |                 |                |         |       |                |
        +-----------------|----------------|-----------------|----------------+
        |                 |                |                 |                |
 0020a0 |      flags      | os information |  blocks[0]=24   |   blocks[1]    |
        |                 |                |                 |                |
        +-----------------|----------------|-----------------|----------------+
        |                 |                |                 |                |
 0020b0 |      flags      | os information |  blocks[0]=24   |   blocks[1]    |
        |                 |                |                 |                |
        +-----------------|----------------|-----------------|----------------+
        |                 |                |                 |                |
 0020c0 |    blocks[2]    |   blocks[3]    |   blocks[4]     |   blocks[5]    |
        |                 |                |                 |                |
        +-----------------|----------------|-----------------|----------------+
        |                 |                |                 |                |
 0020d0 |    blocks[6]    |   blocks[7]    |   blocks[8]     |   blocks[9]    |
        |                 |                |                 |                |
        +-----------------|----------------|-----------------|----------------+
        |                 |                |                 |                |
 0020e0 |   blocks[10]    |   blocks[11]   |   blocks[12]    |   blocks[13]   |
        |                 |                |                 |                |
        +-----------------|---------------------------------------------------+
        |                 |                                                   |
 0020f0 |   blocks[14]    |                      padding                      |
        |                 |                                                   |
        +-----------------|---------------------------------------------------+
```
因为磁盘共1MB，依据规则，需要分配128个inode（1MB/8KB）；而每个inode占据128B，因此inode表占据16个块（128/(1KB/128B)），也即第8~23块都是inode。再由于根目录的inode为2，所以其起始地址为0x002080。
	- 需要注意图中blockcount是以512字节为单位，而计算出的块数目。因为磁盘扇区大小为512字节。

#### 数据块 （根目录数据块为例）
```
         16                  12                  8                   4                   0
         +-------------------|---------|----|----|-------------------|-------------------+
         |                   |  record |name|file|                   |                   |
 006000  |      inode:2      |  len:12 |len:|type|         "."       |      inode:2      |
         |                   |         | 1  | :2 |                   |                   |
         +--------|----|-----|---------|----|----|-------------------|--------|----|-----+
         | record |name|file |                   |                   | record |name|file |
 006010  | len:12 |len:|type |        ".."       |     inode:11      | len:   |len:|type |
         |        | 1  | :2  |                   |                   | 1000   | 10 | :2  |
         +--------|----|------------------------------------------------------|----|-----+
         |                                                                               |
 006020  |    "lost+found"                                                               |
         |                                                                               |
         +-------------------------------------------------------------------------------+
         |                                                                               |
 006030  |                                                                               |
         |                                                                               |
         +-------------------------------------------------------------------------------+
```
根目录的inode指明了其数据块位于第24块，因此其其实地址为0x006000。
- 目录的数据块由很多不定长记录组成，每条记录描述目录中的一个文件或子目录。
- 根目录下固定有一个子目录：lost+found，并且其inode号为11。当磁盘检查检测到出错的数据块时，这些数据块就被挂在lost+found目录下，因为是“无主之物”
- 因为当前根目录下就这三条记录，而最后一条记录其长度为剩余块长度，当有新文件创建时，就截断原纪录（从0字节开始），并创建新纪录。
- 如果一个数据块存储不了所有的文件时，就会申请一个新的数据块，并将其块索引填充到blocks[1]，这样的索引共有15个，后面会详细分析。
- 文件类型参见下表：

编码 | 文件类型
---- | -----
0 | 未知类型 （unknown）
1 | 常规文件 （regular file）
2 | 目录 （directory）
3 | 字符设备 （character device）
4 | 块设备（block device）
5 | 命名管道（named pipe）
6 | 套接字（socket）
7 | 符号链接（symbol link）
