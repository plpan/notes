### linux虚拟文件系统
linux支持多种文件系统，如：ext2、FAT、NTFS等，由于每种文件系统磁盘的存储布局相差很大，如何实现呢？

linux在文件系统之上又封装了一层：虚拟文件系统（VFS，Virtual FileSystem）。它对底层所有文件系统进行了抽象，提供一组操作函数来操作底层文件系统。

#### 数据结构
VFS文件系统主要由[file](https://github.com/plpan/linux/blob/master/include/linux/fs.h#L576)、[dentry](https://github.com/plpan/linux/blob/master/include/linux/dcache.h#L83)、[inode](https://github.com/plpan/linux/blob/master/include/linux/fs.h#L426)、[super_block](https://github.com/plpan/linux/blob/master/include/linux/fs.h#L754)等结构体组成。

每个进程在PCB(进程控制块)中都保存了一份文件描述符表，文件描述符就是这个表的索引，每个表项都指向一个打开文件的指针。内核就是用file结构体来表示打开的文件，而文件描述符表中的指针就是指向file结构体。

在file结构体中维护了f_flags成员表征文件状态，以及f_pos成员表征当前读写位置。当一个进程或多个进程都打开同一文件时，它们其实对应了不同的file结构体，每个file结构体可以有不同的f_flags和f_pos。此外，file结构体中还有一个f_count成员，表征引用计数，当使用dup或dup2时，file结构体的引用计数就加1，当其引用计数大于1时，调用close并不会真的释放file结构体，而仅仅是将引用计数减一，当引用计数减为0时，才会真正的释放file结构体。

file结构体还有一个file_operations结构体，这个结构体中存储了各种文件操作的函数指针，指向内核实现文件操作的函数。用户程序调用read、open、write等操作都是由内核函数来完成。针对同一个文件系统的常规文件，file结构体重file_operations应该都是指向同一个结构体；针对不同类型文件、或是跨文件系统，那么肯定是指向不同的file_operation结构体。读写对应设备文件的file_operations应该由对应的设备驱动实现。

此外，每个file结构体还有一个dentry指针，指向目录项的内核数据结构，其中dentry就是directory entry的缩写。在我们根据文件路径层层遍历最终找到文件inode这个过程中，涉及到很多磁盘操作，操作系统针对这个问题进行了专门的优化，也即缓存目录树。从根目录开始，在遍历目录的过程中，如果目录已经在缓存中，则直接读取dentry，否则从磁盘中读取目录的inode节点。最终读取到文件的inode信息，并将其保存在表征文件dentry的结构体中。注意，dentry cache仅保存最近使用到的目录项，低层算法是lru。

每个dentry结构体都有一个指针指向inode结构体，保存着从磁盘读取的inode信息。如果多个dentry的inode指针指向同一个inode结构体，则说明该多个文件互为硬链接。除了基本的inode信息之外，inode结构体中还有一个指向inode_operations结构体的指针，类似于file_operations结构体，inode_operations结构体中也是一组内核函数的函数指针，如删除文件、删除目录等。属于同一文件系统的inode结构体都可以指向同一个inode_operations结构体。

inode结构体中有一个指向super_block结构体的指针。super_block保存着从磁盘分区超级块中存储的信息，如文件系统、块大小等。结构体中有一个s_root成员描述了文件系统的挂载点，也即被mount的位置。

```
  P1. fd=open("/home/user/a",O_RDONLY)                   file_operations
                                                  +--------->--------+
 files_struct                 file                |         |read    |
    +-----+             +----------------+        |         +--------+
    |  0  |     +------->f_flags:O_RDONLY|        |         |write   |
    +-----+     |       +----------------+        |         +--------+
    |  1  |     |       |f_pos:0         |        |         |open    |
    +-----+     |       +----------------+        |         +--------+
    |  2  |     |       |f_count:1       |        |         |release |
    +-----+     |       +----------------+        |         +--------+
    |  3  ------+       |f_op            ---------|         |......  |                            inode
    +-----+             +----------------+        |         +--------+                      +----------------+
                        |f_dentry        ---------------+             +---------+----------->i_size:1000     |
                        +----------------+        |     |             |         |           +----------------+
                                                  |     |             |         |           |i_mode:0100644  |
  P2. fd=open("/home/user/a",O_WRONLY)            |     |             |         |           +----------------+     inode_operations
                                                  |     |             |         |           |f_op            ---------->-------+
 files_struct                 file                |     |             |         |           +----------------+        |link    |
    +-----+             +----------------+        |     |             |         |        +---f_sb            |        +--------+
    |  0  |     +------->f_flags:O_WRONLY|        |     |             |         |        |  +----------------+        |unlink  |
    +-----+     |       +----------------+        |     |             |         |        |  |......          |        +--------+
    |  1  |     |       |f_pos:5         |        |     |             |         |        |  +----------------+        |mkdir   |
    +-----+     |       +----------------+        |     |             |         |        |                            +--------+
    |  2  |     |       |f_count:1       |        |     |             |         |        |                            |rmdir   |
    +-----+     |       +----------------+        |     |             |         |        |          super_block       +--------+
    |  3  ------+       |f_op            ---------|     |             |         |        +------->----------------+   |......  |
    +-----+             +----------------+        |     |            dentry cache                |s_type:ext2     |   +--------+
                        |f_dentry        ---------------|         +---|---------|---+            +----------------+
                        +----------------+        |     |         |   |         |   |            |s_blocksize:1024|
                                                  |     |         | +-|-+     +-|-+ |            +----------------+
  P3. fd=open("/home/user/b",O_WRONLY)            |     +----------->   <-+ +->   <------+    +---s_root          |
                                                  |               | +---+ | | +---+ |    |    |  +----------------+
 files_struct                  file               |               |   a   | |   b   |    |    |  |......          |
    +-----+             +----------------+        |               |      +|-|+      |    |    |  +----------------+
    |  0  |     +------->f_flags:O_WRONLY|        |               |      |   <--+   |    |    |
    +-----+     |       +----------------+        |               |      +---+  |   |    |    |
    |  1  |     |       |f_pos:0         |        |               |      user   |   |    |    |
    +-----+     |       +----------------+        |               | +---+     +-|-+ |    |    |
    |  2  |     |       |f_count:1       |        |               | |   ------>   <-----------+
    +-----+     |       +----------------+        |               | +---+     +---+ |    |
    |  3  ------+       |f_op            ---------+               |   /       home  |    |
    +-----+             +----------------+                        +-----------------+    |
                        |f_dentry        ------------------------------------------------+
                        +----------------+
```
