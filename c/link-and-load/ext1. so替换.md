### 动态链接库升级
C语言程序从源代码编程可执行文件，一般需要经过四个步骤：预处理、编译、汇编和链接：
- 预处理负责展开宏、头文件、删除注释等
- 编译负责词法、语法、语义分析等，并产生汇编文件
- 汇编负责将汇编指令翻译成机器指令，并生成可执行目标文件
- 链接则负责对可执行目标文件集合进行链接，完成符号解析、地址填充等，并最后生成可执行文件

其中前三步都是针对单个源文件进行处理，而链接的作用对象则是所有目标文件与库。链接又分为两种：
- 静态链接：将可执行目标文件与库链接打包到一个可执行文件中，这里所使用到的库就是静态库，而静态库就是一个目标文件的集合，linux下静态库一般形如libXXX.a。
- 动态链接：将可执行目标文件打包到一个可执行文件中，并在运行时对库进行动态链接，这里使用到的库就是动态库，动态库在内存中只会保存一份实例，并通过地址无关技术被映射至所有使用到该动态库的地址空间中，linux下动态库一般形如libXXX.so。

当链接库需要升级时，这里我们主要关注动态库，因为静态库的升级和应用程序升级是一致的。动态库升级主要有两种方式：
- 静态替换
- 动态替换

静态替换动态库，用新so直接替换老so文件。仅当应用程序下次重启时，才会生效，这是因为老so文件已经被加载至程序空间中。这里需要注意的是，若程序已经启动，直接执行cp命令拷贝覆盖老so会导致应用程序崩溃，可以通过mv老so，或rm老so，然后再cp拷贝覆盖即可。其原因是应用程序启动时，会加载so到内存，分配一个inode结构体来存储so的相关信息，当执行rm或mv操作时，不会对该inode结构体有任何影响(rm不会立即删除，而是等到文件引用为0时才执行物理删除；mv仅是一个rename操作，不会影响内存数据结构inode)，只会对应用程序重启造成影响，因为访问不到该so文件。而cp操作则是直接操作该inode结构体，具体参见strace记录：
```
# strace cp ../apcu.so apuc.so
......
stat("apcu.so", {st_mode=S_IFREG|0755, st_size=424671, ...}) = 0
stat("../apcu.so", {st_mode=S_IFREG|0755, st_size=424671, ...}) = 0
stat("apcu.so", {st_mode=S_IFREG|0755, st_size=424671, ...}) = 0
open("../apcu.so", O_RDONLY)            = 3
fstat(3, {st_mode=S_IFREG|0755, st_size=424671, ...}) = 0
open("apcu.so", O_WRONLY|O_TRUNC)       = 4
fstat(4, {st_mode=S_IFREG|0755, st_size=0, ...}) = 0
......
```
注意倒数第二行，调用open时附带O_TRUNC标识符，该标识符会将apcu.so文件内容清零，这就会导致应用程序无法识别该so文件类型，进而导致程序崩溃：ld.so加载该动态库时，发现其内容为空，会报segmentation fault段错误。

值得注意的是，cp操作对所有类型文件操作都是作用在原inode之上的。

动态替换是在不重启应用程序的前提下完成对so的替换，主要是借助pstrace系统调用来实现的。
```
#include<sys/ptrace.h>
int ptrace(int request,int pid,int addr,int data);
```
该函数通过用户传入的request参数来执行对应的功能，主要包含以下功能：
- PTRACE_ATTACH：跟踪目标进程，目标进程由pid标识，成功时，被跟踪进程成为当前进程的子进程，并接受SIGSTOP信号
- PTRACE_DETACH：结束对目标进程的跟踪
- PTRACE_POKEDATA：往目标进程的内存地址中写入一个字节，其中addr存储写入地址，data存储写入的数据
- PTRACE_PEEKDATA：从目标进程的内存地址中读取一个字节，其中addr存储读取地址，读取的数据存储在返回值中
```
+----------------------+
|                      |
|      跟踪目标进程      |   PTRACE_ATTACH
|                      |
+-----------|----------+
            |
            |
+-----------v----------+
|                      |
|      确定写入地址      |   pmap/lsof
|                      |
+-----------|----------+
            |
            |
+-----------v----------+
|                      |
|      替换写入内容      |   PSTRACE_POKEDATA
|                      |
+-----------|----------+
            |
            |
+-----------v----------+
|                      |
|       结束跟踪        |   PSTRACE_DETACH
|                      |
+----------------------+
```
具体实现，大家可以自己一试。

### Reference
1. https://www.freebuf.com/articles/system/116489.html
